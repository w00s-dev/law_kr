# korea-law: Daily Sync Workflow
# 매일 00:00 KST (15:00 UTC)에 법령 데이터 동기화
#
# ⚠️ 중요: 이 동기화 데이터는 AI 검증용입니다.
# 법적 효력의 최종 판단은 국가법령정보센터(law.go.kr)를 참조하세요.

name: Daily Sync

on:
  schedule:
    # 매일 00:00 KST (15:00 UTC 전날)
    - cron: '0 15 * * *'
  workflow_dispatch: # 수동 실행 가능

env:
  KOREA_LAW_API_KEY: ${{ secrets.KOREA_LAW_API_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: korea-law/package-lock.json

      - name: Install dependencies
        working-directory: ./korea-law
        run: npm ci

      - name: Build
        working-directory: ./korea-law
        run: npm run build

      - name: Run Daily Sync
        working-directory: ./korea-law
        run: npm run sync
        env:
          KOREA_LAW_API_KEY: ${{ secrets.KOREA_LAW_API_KEY }}

      - name: Run Precedent Sync
        working-directory: ./korea-law
        run: npx ts-node src/sync/precedent-sync.ts
        env:
          KOREA_LAW_API_KEY: ${{ secrets.KOREA_LAW_API_KEY }}

      - name: Run Term Extraction
        working-directory: ./korea-law
        run: npx ts-node src/sync/term-extractor.ts
        env:
          KOREA_LAW_API_KEY: ${{ secrets.KOREA_LAW_API_KEY }}

      - name: Upload Sync Results
        uses: actions/upload-artifact@v4
        with:
          name: sync-results-${{ github.run_number }}
          path: korea-law/data/
          retention-days: 7

      - name: Notify on Failure
        if: failure()
        run: |
          echo "::error::Daily sync failed! Check the logs for details."

